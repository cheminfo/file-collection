<html>

<head>
</head>

<body>
  <p>
    You should build the project `npm run build` before testing this page.
  </p>
  Select files:
  <input type="file" id="file-picker" name="fileCollection" multiple />
  or select directories:
  <input type="file" id="directory-picker" name="fileCollection" multiple webkitdirectory="true" />
  Upload a 'ium' (zip) file
  <input type="file" id="ium-picker" name="fileCollection" />
  <button id="ium-downloader">Download ium</button>
  <button id="zip-downloader">Download zip</button>
  <button id="web-source-picker">appendWebSource</button>

  <div style="display: flex">
    <div style="background-color: pink" id="listing"></div>
    <div style="background-color: lightgreen" id="listingCollection"></div>
  </div>

  <script type="module">
    import { FileCollection } from '../dist/file-collection.esm.js';

    let fileCollection;

    const $filePicker = document.getElementById('file-picker');
    const $directoryPicker = document.getElementById('directory-picker');
    const $iumPicker = document.getElementById('ium-picker');
    const $iumDownloader = document.getElementById('ium-downloader');
    const $zipDownloader = document.getElementById('zip-downloader');
    const $webSourceDownloader = document.getElementById('web-source-picker');

    $filePicker.addEventListener('change', uploadFiles);
    $directoryPicker.addEventListener('change', uploadFiles);
    $iumPicker.addEventListener('change', fromIum);
    $iumDownloader.addEventListener('click', downloadIum);
    $zipDownloader.addEventListener('click', downloadZip);
    $webSourceDownloader.addEventListener('click', appendWebSource);

    async function appendWebSource() {
      fileCollection = new FileCollection();
      await fileCollection.appendWebSource('https://image-js.github.io/image-dataset-demo/index.json');
      displayFileCollection(fileCollection);
    }

    async function uploadFiles(event) {
      let files = event.target.files;
      console.log({ files });
      for (const file of files) {
        console.log(file);
      }
      displayFileList(files);
      fileCollection = new FileCollection();
      await fileCollection.appendFileList(files);
      displayFileCollection(fileCollection);
    }

    async function fromIum(event) {
      let files = event.target.files;
      displayFileList(files);
      fileCollection = await FileCollection.fromIum(files[0]);
      displayFileCollection(fileCollection);
    }

    async function displayFileList(files) {
      let listing = document.getElementById('listing');
      let html = [];
      html.push('<table>');
      html.push(
        '<tr><th>webkitRelativePath</th><th>name</th><th>Text size</th><th>ArrayBuffer size</th></tr>',
      );
      for (let file of files) {
        html.push(`
            <tr>
              <td>
                ${file.webkitRelativePath}
              </td><td>
                ${file.name}
              </td><td>
                ${(await file.text()).length}
              </td><td>
                ${(await file.arrayBuffer()).byteLength}
              </td>
            </tr>
          `);
      }
      html.push('</table>');
      listing.innerHTML = html.join('\n');
    }

    async function displayFileCollection(fileCollection) {
      let listing = document.getElementById('listingCollection');
      let html = [];
      html.push('<table>');
      html.push(
        '<tr><th>relativePath</th><th>name</th><th>Text size</th><th>ArrayBuffer size</th></tr>',
      );
      for (let file of fileCollection) {
        html.push(`
            <tr>
              <td>
                ${file.relativePath}
              </td><td>
                ${file.name}
              </td><td>
                ${(await file.text()).length}
              </td><td>
                ${(await file.arrayBuffer()).byteLength}
              </td>
            </tr>
          `);
      }
      html.push('</table>');
      listing.innerHTML = html.join('\n');
    }

    async function downloadIum(e) {
      var blob = new Blob([await fileCollection.toIum()], { type: "application/zip" });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = 'data.ium.zip';
      a.click();
    }

    async function downloadZip(e) {
      var blob = new Blob([await fileCollection.toZip()], { type: "application/zip" });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = 'data.zip';
      a.click();
    }

  </script>
</body>

</html>